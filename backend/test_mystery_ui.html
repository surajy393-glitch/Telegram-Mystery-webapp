<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystery Match API Tester</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .response {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #4ade80;
        }
        .error {
            color: #f87171;
        }
        .label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #fbbf24;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Mystery Match API Tester</h1>
        
        <!-- User ID Input -->
        <div class="section">
            <label class="label">Your Telegram User ID:</label>
            <input type="number" id="userId" placeholder="Enter your Telegram User ID" value="99999999">
            <small style="opacity: 0.7;">Use your real Telegram ID from the bot, or test with 99999999</small>
        </div>

        <!-- Find Match -->
        <div class="section">
            <h3>üé≤ Find Mystery Match</h3>
            <label class="label">Age Range:</label>
            <input type="number" id="minAge" placeholder="Min Age" value="18" style="width: 48%; display: inline-block;">
            <input type="number" id="maxAge" placeholder="Max Age" value="35" style="width: 48%; display: inline-block; margin-left: 4%;">
            <button onclick="findMatch()">Find Mystery Match</button>
            <div id="matchResponse" class="response" style="display: none;"></div>
        </div>

        <!-- My Matches -->
        <div class="section">
            <h3>üí¨ My Active Matches</h3>
            <button onclick="getMatches()">Get My Matches</button>
            <div id="matchesResponse" class="response" style="display: none;"></div>
        </div>

        <!-- User Stats -->
        <div class="section">
            <h3>üìä User Statistics</h3>
            <button onclick="getStats()">Get My Stats</button>
            <div id="statsResponse" class="stats-grid" style="display: none;"></div>
        </div>

        <!-- Send Message -->
        <div class="section">
            <h3>üíå Send Message</h3>
            <label class="label">Match ID:</label>
            <input type="number" id="matchId" placeholder="Match ID">
            <label class="label">Message:</label>
            <input type="text" id="messageText" placeholder="Type your message...">
            <button onclick="sendMessage()">Send Message</button>
            <div id="messageResponse" class="response" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001/api/mystery';

        async function findMatch() {
            const userId = document.getElementById('userId').value;
            const minAge = document.getElementById('minAge').value;
            const maxAge = document.getElementById('maxAge').value;
            const responseDiv = document.getElementById('matchResponse');
            
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '‚è≥ Finding mystery match...';
            
            try {
                const response = await fetch(`${API_BASE}/find-match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        preferred_age_min: parseInt(minAge),
                        preferred_age_max: parseInt(maxAge)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    responseDiv.innerHTML = `
                        <div class="success">‚úÖ Match Found!</div>
                        <div style="margin-top: 10px;">
                            <strong>Match ID:</strong> ${data.match_id}<br>
                            <strong>Mystery User:</strong> ${data.mystery_user.display_name}<br>
                            <strong>Unlock Level:</strong> ${data.unlock_level || 0}<br>
                            <strong>Messages to unlock:</strong> ${data.next_unlock_at || 10}<br>
                            <strong>Expires:</strong> ${new Date(data.expires_at).toLocaleString()}<br>
                            <strong>Premium:</strong> ${data.is_premium ? 'Yes ‚ú®' : 'No (3 matches/day)'}
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(251, 191, 36, 0.2); border-radius: 8px;">
                            üí° Use Match ID <strong>${data.match_id}</strong> to send messages below!
                        </div>
                    `;
                } else {
                    responseDiv.innerHTML = `
                        <div class="error">‚ùå ${data.message || data.error}</div>
                    `;
                }
            } catch (error) {
                responseDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function getMatches() {
            const userId = document.getElementById('userId').value;
            const responseDiv = document.getElementById('matchesResponse');
            
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '‚è≥ Loading matches...';
            
            try {
                const response = await fetch(`${API_BASE}/my-matches/${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.matches.length === 0) {
                        responseDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                üòä No active matches yet<br>
                                Click "Find Mystery Match" above to start!
                            </div>
                        `;
                    } else {
                        let html = `<div class="success">‚úÖ ${data.total} Active Match(es)</div>`;
                        html += `<div style="margin-top: 10px;"><strong>Daily Limit:</strong> ${data.daily_limit || 'Unlimited (Premium)'}</div>`;
                        
                        data.matches.forEach(match => {
                            html += `
                                <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                                    <strong>Match #${match.match_id}</strong><br>
                                    <strong>Messages:</strong> ${match.message_count}/${match.next_unlock_at || 'Fully unlocked!'}<br>
                                    <strong>Unlock Level:</strong> ${match.unlock_level}/4<br>
                                    <strong>Expires:</strong> ${new Date(match.expires_at).toLocaleString()}<br>
                                    ${match.partner.age ? `<strong>Partner:</strong> ${match.partner.age}yo from ${match.partner.city || 'Unknown'}` : '<strong>Partner:</strong> Mystery User üé≠'}
                                </div>
                            `;
                        });
                        responseDiv.innerHTML = html;
                    }
                } else {
                    responseDiv.innerHTML = `<div class="error">‚ùå Error loading matches</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function getStats() {
            const userId = document.getElementById('userId').value;
            const responseDiv = document.getElementById('statsResponse');
            
            responseDiv.style.display = 'grid';
            responseDiv.innerHTML = '‚è≥ Loading stats...';
            
            try {
                const response = await fetch(`${API_BASE}/stats/${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    responseDiv.innerHTML = `
                        <div class="stat-box">
                            <div class="stat-number">${data.total_matches}</div>
                            <div class="stat-label">Total Matches</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${data.active_matches}</div>
                            <div class="stat-label">Active Matches</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${data.today_matches}/${data.daily_limit || '‚àû'}</div>
                            <div class="stat-label">Today's Matches</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${data.messages_sent}</div>
                            <div class="stat-label">Messages Sent</div>
                        </div>
                        <div class="stat-box" style="grid-column: 1 / -1;">
                            <div class="stat-label">${data.is_premium ? '‚ú® Premium User' : 'üÜì Free User'}</div>
                        </div>
                    `;
                } else {
                    responseDiv.innerHTML = `<div class="error">‚ùå Error loading stats</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function sendMessage() {
            const userId = document.getElementById('userId').value;
            const matchId = document.getElementById('matchId').value;
            const messageText = document.getElementById('messageText').value;
            const responseDiv = document.getElementById('messageResponse');
            
            if (!matchId || !messageText) {
                alert('Please enter Match ID and message text');
                return;
            }
            
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '‚è≥ Sending message...';
            
            try {
                const response = await fetch(`${API_BASE}/send-message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        match_id: parseInt(matchId),
                        sender_id: parseInt(userId),
                        message_text: messageText
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let html = `<div class="success">‚úÖ Message sent!</div>`;
                    html += `<div style="margin-top: 10px;">
                        <strong>Message Count:</strong> ${data.message_count}<br>
                        <strong>Unlock Level:</strong> ${data.unlock_level}/4<br>
                    `;
                    
                    if (data.unlock_achieved) {
                        html += `
                            <div style="margin-top: 15px; padding: 15px; background: rgba(251, 191, 36, 0.3); border-radius: 10px;">
                                üéâ <strong>NEW UNLOCK!</strong><br>
                                Level ${data.unlock_achieved.level}: ${data.unlock_achieved.unlocked.join(', ')}
                            </div>
                        `;
                    } else {
                        html += `<strong>Next unlock at:</strong> ${data.next_unlock_at || 'Fully unlocked!'} messages`;
                    }
                    
                    html += `</div>`;
                    responseDiv.innerHTML = html;
                    document.getElementById('messageText').value = '';
                } else {
                    responseDiv.innerHTML = `<div class="error">‚ùå Error sending message</div>`;
                }
            } catch (error) {
                responseDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
